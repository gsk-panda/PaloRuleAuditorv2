---
- name: Monitor and Remediate Palo Alto VPN/BGP Status
  hosts: palo_alto_firewalls
  gather_facts: no
  collections:
    - paloaltonetworks.panos

  vars:
    # Firewall credentials
    provider:
      ip_address: "{{ ansible_host }}"
      username: "{{ pan_username }}"
      password: "{{ pan_password }}"
    
    # BGP monitoring settings
    bgp_down_threshold: 300  # 5 minutes in seconds
    state_file: "/tmp/bgp_state_{{ inventory_hostname }}.json"

  tasks:
    - name: Get BGP peer status
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "show routing protocol bgp peer"
      register: bgp_status

    - name: Parse BGP peer information
      set_fact:
        bgp_peers: "{{ bgp_status.stdout | regex_findall('<entry name=\"([^\"]+)\">[\\s\\S]*?<status>([^<]+)</status>[\\s\\S]*?<virtual-router>([^<]+)</virtual-router>', multiline=True) }}"

    - name: Load previous BGP state
      slurp:
        src: "{{ state_file }}"
      register: previous_state
      ignore_errors: yes

    - name: Parse previous state
      set_fact:
        prev_bgp_state: "{{ previous_state.content | b64decode | from_json }}"
      when: previous_state is not failed

    - name: Initialize previous state if not exists
      set_fact:
        prev_bgp_state: {}
      when: previous_state is failed

    - name: Check for BGP peers down longer than threshold
      set_fact:
        peers_to_remediate: >-
          {{
            bgp_peers | 
            selectattr('1', 'equalto', 'Idle') |
            map('first') |
            list |
            select('in', prev_bgp_state.keys()) |
            select('lambda', 'peer', (ansible_date_time.epoch | int) - prev_bgp_state[peer] >= bgp_down_threshold) |
            list
          }}

    - name: Update BGP state tracking
      set_fact:
        current_bgp_state: >-
          {{
            dict(
              bgp_peers |
              selectattr('1', 'equalto', 'Idle') |
              map('first') |
              map('regex_replace', '^(.*)$', '[\1, ' ~ (prev_bgp_state.get(item, ansible_date_time.epoch) | default(ansible_date_time.epoch)) ~ ']') |
              map('from_json') |
              list
            )
          }}

    - name: Save current BGP state
      copy:
        content: "{{ current_bgp_state | to_json }}"
        dest: "{{ state_file }}"
      delegate_to: localhost

    - name: Get IPSec tunnel information
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "show vpn ipsec-sa"
      register: ipsec_tunnels
      when: peers_to_remediate | length > 0

    - name: Get VPN gateway to tunnel mapping
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "show vpn gateway"
      register: vpn_gateways
      when: peers_to_remediate | length > 0

    - name: Parse tunnel names for affected BGP peers
      set_fact:
        tunnels_to_clear: "{{ ipsec_tunnels.stdout | regex_findall('<tunnel>([^<]+)</tunnel>') | unique }}"
      when: peers_to_remediate | length > 0

    - name: Clear IPSec VPN sessions for affected tunnels
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "clear vpn ipsec-sa tunnel {{ item }}"
      loop: "{{ tunnels_to_clear }}"
      when: peers_to_remediate | length > 0
      register: clear_vpn_result

    - name: Wait for tunnels to stabilize
      pause:
        seconds: 10
      when: peers_to_remediate | length > 0

    - name: Get list of VPN gateways
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "show vpn gateway"
      register: gateway_list
      when: peers_to_remediate | length > 0

    - name: Parse gateway names
      set_fact:
        affected_gateways: "{{ gateway_list.stdout | regex_findall('<Gateway>([^<]+)</Gateway>') | unique }}"
      when: peers_to_remediate | length > 0

    - name: Test VPN connectivity for affected gateways
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "test vpn ipsec-sa gateway {{ item }}"
      loop: "{{ affected_gateways }}"
      when: peers_to_remediate | length > 0
      register: vpn_test_result

    - name: Clear stale VPN sessions
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: "clear vpn ike-sa gateway {{ item }}"
      loop: "{{ affected_gateways }}"
      when: peers_to_remediate | length > 0

    - name: Report remediation actions
      debug:
        msg: |
          BGP Peers requiring remediation: {{ peers_to_remediate }}
          Tunnels cleared: {{ tunnels_to_clear | default([]) }}
          Gateways tested: {{ affected_gateways | default([]) }}
      when: peers_to_remediate | length > 0

    - name: No remediation needed
      debug:
        msg: "All BGP peers are up or haven't exceeded the down threshold"
      when: peers_to_remediate | length == 0
